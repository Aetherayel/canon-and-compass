---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import TopLayout from "@layouts/TopLayout.astro";
import BottomLayout from "@layouts/BottomLayout.astro";
import ArticleTopLayout from "@layouts/ArticleTopLayout.astro";
import ArticleBottomLayout from "@layouts/ArticleBottomLayout.astro";

export async function getStaticPaths() {
  const canonNotes = (await getCollection("canon_notes")).filter(
    (entry) => !entry.slug.includes("/"),
  );
  return canonNotes.map((note) => ({
    params: { slug: note.slug },
    props: note,
  }));
}

type Props = CollectionEntry<"canon_notes">;
const canonNote = Astro.props;
const { title, summary } = canonNote.data;

// Build a list of multi-part Canon Notes series to surface below the article.
// Currently sourced from the dedicated `foundations-of-discernment` collection.
const fodEntries = await getCollection("foundations-of-discernment");
const seriesMeta = fodEntries.length
  ? [
      {
        prefix: "foundations-of-discernment",
        title:
          fodEntries[0].data.series || "Foundations of Discernment",
        count: fodEntries.length,
      },
    ]
  : [];
---

<PageLayout title={title} description={summary}>
  <TopLayout>
    <div class="animate">
      <ArticleTopLayout entry={canonNote} />
    </div>
  </TopLayout>
  <BottomLayout>
    <div class="animate">
      <ArticleBottomLayout entry={canonNote} />
    </div>
    {seriesMeta.length > 0 && (
      <section class="animate mt-10">
        <h2 class="text-xl font-semibold text-black dark:text-white">
          Explore Canon Notes Series
        </h2>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          {seriesMeta.map((s) => (
            <a
              href={`/${s.prefix}`}
              class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"
            >
              <div class="w-full group-hover:text-black group-hover:dark:text-white blend">
                <div class="text-sm uppercase">
                  {s.count} part{s.count === 1 ? "" : "s"}
                </div>
                <div class="font-semibold mt-2 text-black dark:text-white">
                  {s.title}
                </div>
                <div class="text-sm mt-1 opacity-80">
                  A multi-part Canon Notes series
                </div>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white">
                <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out" />
                <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out" />
              </svg>
            </a>
          ))}
        </div>
      </section>
    )}
  </BottomLayout>
</PageLayout>
