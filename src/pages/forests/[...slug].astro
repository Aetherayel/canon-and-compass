---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import TopLayout from "@layouts/TopLayout.astro";
import BottomLayout from "@layouts/BottomLayout.astro";
import ArticleTopLayout from "@layouts/ArticleTopLayout.astro";
import ArticleBottomLayout from "@layouts/ArticleBottomLayout.astro";
import { cn } from "@lib/utils";

export async function getStaticPaths() {
  const forests = await getCollection("forests");

  const worldviewPaths = forests
    .filter((entry) => entry.data.type !== "forest" && !entry.data.draft)
    .map((entry) => ({
      params: { slug: entry.slug },
      props: { type: "entry", entry },
    }));

  const forestPaths = forests
    .filter((entry) => entry.data.type === "forest" && !entry.data.draft)
    .map((entry) => ({
      params: { slug: entry.slug },
      props: { type: "forest", entry },
    }));

  return [...worldviewPaths, ...forestPaths];
}

type ForestEntry = CollectionEntry<"forests">;

type Props = { type: "entry" | "forest"; entry: ForestEntry };

const props = Astro.props as Props;
const isForest = props.type === "forest";
const forest = isForest ? props.entry : null;
const worldview = isForest ? null : props.entry;

const pageTitle = forest?.data.title ?? worldview?.data.title ?? "";
const pageDescription = forest?.data.summary ?? worldview?.data.summary ?? "";
const seriesName = forest?.data.series ?? worldview?.data.series;

const seriesEntries = seriesName
  ? (await getCollection("forests"))
      .filter(
        (entry) =>
          entry.data.type !== "forest" &&
          entry.data.series === seriesName &&
          !entry.data.draft,
      )
      .sort((a, b) => {
        const aPart =
          (a.data as any).part ?? (a.data as any).day ?? Number.MAX_SAFE_INTEGER;
        const bPart =
          (b.data as any).part ?? (b.data as any).day ?? Number.MAX_SAFE_INTEGER;
        if (aPart !== bPart) return aPart - bPart;
        return a.data.date.getTime() - b.data.date.getTime();
      })
  : [];

const activePart = worldview
  ? (worldview.data as any).part ?? (worldview.data as any).day
  : undefined;

const splitParagraphs = (text: string) =>
  text
    .split(/\n\s*\n/)
    .map((paragraph) => paragraph.trim())
    .filter(Boolean);
---

<PageLayout title={pageTitle} description={pageDescription}>
  {isForest ? (
    <>
      <TopLayout>
        <div class="animate space-y-3">
          <div class="flex flex-wrap items-center gap-2 text-xs uppercase text-neutral-600 dark:text-neutral-300">
            <a href="/forests" class="hover:underline">
              The Forests
            </a>
            <span class="text-neutral-400 dark:text-neutral-500">/</span>
            <span>{forest?.data.series} Forest</span>
          </div>
          <h1 class="text-3xl font-semibold text-black dark:text-white mt-2">
            {forest?.data.title}
          </h1>
          <p class="text-lg text-neutral-700 dark:text-neutral-300">
            {forest?.data.subtitle}
          </p>
          <p class="text-sm text-neutral-600 dark:text-neutral-400">
            This is not a definition. It is a felt description.
          </p>
        </div>
      </TopLayout>
      <BottomLayout>
        <div class="animate space-y-12">
          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              The Climate
            </h2>
            <div class="mt-3 space-y-3 text-base text-neutral-700 dark:text-neutral-300">
              {forest?.data.climate &&
                splitParagraphs(forest.data.climate).map((paragraph) => (
                  <p>{paragraph}</p>
                ))}
            </div>
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              The Canopy
            </h2>
            <div class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
              This is the unseen structure.
            </div>
            <ul class="mt-3 space-y-2 text-sm text-neutral-700 dark:text-neutral-300">
              {forest?.data.canopy?.map((item) => (
                <li class="flex items-start gap-2">
                  <span class="mt-2 h-1.5 w-1.5 rounded-full bg-neutral-400 dark:bg-neutral-500"></span>
                  <span>Under this canopy, {item}</span>
                </li>
              ))}
            </ul>
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              The Quiet Gospel
            </h2>
            <div class="mt-3 rounded-2xl border border-black/10 bg-white/70 p-5 text-sm text-neutral-700 shadow-sm dark:border-white/15 dark:bg-zinc-900/70 dark:text-neutral-300">
              <div class="text-xs uppercase tracking-wide text-neutral-500 dark:text-neutral-400">
                The quiet gospel of this forest says:
              </div>
              <p class="mt-3 text-lg font-semibold text-black dark:text-white">
                "{forest?.data.quietGospel}"
              </p>
            </div>
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              The Fruit It Normalizes
            </h2>
            <ul class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
              {forest?.data.fruit?.map((item) => (
                <li class="rounded-xl border border-black/10 bg-white/70 p-3 text-sm text-neutral-700 shadow-sm dark:border-white/15 dark:bg-zinc-900/70 dark:text-neutral-300">
                  {item}
                </li>
              ))}
            </ul>
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              The Cost of Staying
            </h2>
            <div class="mt-3 space-y-3 text-base text-neutral-700 dark:text-neutral-300">
              {forest?.data.costStaying &&
                splitParagraphs(forest.data.costStaying).map((paragraph) => (
                  <p>{paragraph}</p>
                ))}
            </div>
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              The Cost of Leaving
            </h2>
            <div class="mt-3 space-y-3 text-base text-neutral-700 dark:text-neutral-300">
              {forest?.data.costLeaving &&
                splitParagraphs(forest.data.costLeaving).map((paragraph) => (
                  <p>{paragraph}</p>
                ))}
            </div>
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              A Path Through the Forest
            </h2>
            <div class="mt-3 space-y-3 text-base text-neutral-700 dark:text-neutral-300">
              {forest?.data.pathIntro &&
                splitParagraphs(forest.data.pathIntro).map((paragraph) => (
                  <p>{paragraph}</p>
                ))}
            </div>
            {seriesEntries.length > 0 ? (
              <ol class="mt-5 space-y-3">
                {seriesEntries.map((entry) => {
                  const partNumber =
                    (entry.data as any).part ?? (entry.data as any).day;
                  return (
                    <li>
                      <a
                        href={`/forests/${entry.slug}`}
                        class="block rounded-xl border border-black/10 bg-white/70 p-4 text-sm text-neutral-700 shadow-sm transition-colors duration-200 ease-in-out hover:bg-black/5 dark:border-white/15 dark:bg-zinc-900/70 dark:text-neutral-300 dark:hover:bg-white/10"
                      >
                        <div class="text-xs uppercase text-neutral-500 dark:text-neutral-400">
                          {partNumber ? `Part ${partNumber}` : "Entry"}
                        </div>
                        <div class="mt-1 font-semibold text-black dark:text-white">
                          {entry.data.title}
                        </div>
                        <div class="mt-1 text-sm text-neutral-600 dark:text-neutral-400">
                          {entry.data.summary}
                        </div>
                      </a>
                    </li>
                  );
                })}
              </ol>
            ) : (
              <p class="mt-4 text-sm text-neutral-600 dark:text-neutral-400">
                This forest does not have trail markers yet.
              </p>
            )}
          </section>

          <section>
            <h2 class="text-xl font-semibold text-black dark:text-white">
              Gentle Orientation Forward
            </h2>
            <div class="mt-3 space-y-3 text-base text-neutral-700 dark:text-neutral-300">
              {forest?.data.orientation &&
                splitParagraphs(forest.data.orientation).map((paragraph) => (
                  <p>{paragraph}</p>
                ))}
            </div>
            {forest?.data.orientationLink && (
              <a
                href={forest.data.orientationLink.href}
                class="mt-5 inline-flex items-center justify-center rounded-full border border-black/15 px-4 py-2 text-sm font-semibold text-black transition-colors duration-300 ease-in-out hover:bg-black/5 dark:border-white/25 dark:text-white dark:hover:bg-white/10"
              >
                {forest.data.orientationLink.label}
              </a>
            )}
          </section>
        </div>
      </BottomLayout>
    </>
  ) : (
    <>
      <TopLayout>
        <div class="animate space-y-3">
          <ArticleTopLayout entry={worldview!} />
          {worldview?.data.series &&
            worldview.data.series.toLowerCase() !== "standalone" && (
              <div class="flex flex-wrap items-center gap-2 text-xs uppercase text-neutral-600 dark:text-neutral-300">
                <span class="px-2 py-1 rounded-full border border-black/15 dark:border-white/20">
                  {worldview.data.series}
                </span>
                <span>
                  {activePart ? `Part ${activePart}` : "Series entry"}
                  {seriesEntries.length > 1
                    ? ` of ${seriesEntries.length}`
                    : ""}
                </span>
              </div>
            )}
        </div>
      </TopLayout>
      <BottomLayout>
        <div class="animate">
          <ArticleBottomLayout entry={worldview!} />
        </div>

        {seriesEntries.length > 1 && (
          <section class="animate mt-10">
            <h2 class="text-lg font-semibold text-black dark:text-white mb-3">
              {worldview?.data.series} Series
            </h2>
            <ol class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {seriesEntries.map((entry) => {
                const isActive = entry.slug === worldview?.slug;
                const partNumber =
                  (entry.data as any).part ?? (entry.data as any).day;
                return (
                  <li>
                    <a
                      href={`/forests/${entry.slug}`}
                      class={cn(
                        "block h-full rounded-lg border p-4 transition-colors duration-200 ease-in-out",
                        "border-black/15 dark:border-white/20 hover:bg-black/5 hover:dark:bg-white/10",
                        isActive &&
                          "border-black dark:border-white bg-black/5 dark:bg-white/10 pointer-events-none",
                      )}
                      aria-current={isActive ? "page" : undefined}
                    >
                      <div class="text-xs uppercase text-neutral-600 dark:text-neutral-300">
                        {partNumber ? `Part ${partNumber}` : "Entry"}
                      </div>
                      <div class="font-semibold text-black dark:text-white mt-1 line-clamp-2">
                        {entry.data.title}
                      </div>
                      <div class="text-sm mt-1 line-clamp-2 text-neutral-700 dark:text-neutral-300">
                        {entry.data.summary}
                      </div>
                    </a>
                  </li>
                );
              })}
            </ol>
          </section>
        )}
      </BottomLayout>
    </>
  )}
</PageLayout>
