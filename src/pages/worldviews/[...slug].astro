---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import TopLayout from "@layouts/TopLayout.astro";
import BottomLayout from "@layouts/BottomLayout.astro";
import ArticleTopLayout from "@layouts/ArticleTopLayout.astro";
import ArticleBottomLayout from "@layouts/ArticleBottomLayout.astro";
import { cn } from "@lib/utils";

export async function getStaticPaths() {
  const worldviews = (await getCollection("worldviews")).filter(
    (entry) => !entry.data.draft,
  );
  return worldviews.map((entry) => ({
    params: { slug: entry.slug },
    props: entry,
  }));
}

type Props = CollectionEntry<"worldviews">;
const worldview = Astro.props;
const { title, summary, series } = worldview.data;

const seriesEntries = (await getCollection("worldviews"))
  .filter(
    (entry) =>
      entry.data.series === series && !entry.data.draft,
  )
  .sort((a, b) => {
    const aPart =
      (a.data as any).part ?? (a.data as any).day ?? Number.MAX_SAFE_INTEGER;
    const bPart =
      (b.data as any).part ?? (b.data as any).day ?? Number.MAX_SAFE_INTEGER;
    if (aPart !== bPart) return aPart - bPart;
    return a.data.date.getTime() - b.data.date.getTime();
  });

const activePart =
  (worldview.data as any).part ?? (worldview.data as any).day;
---

<PageLayout title={title} description={summary}>
  <TopLayout>
    <div class="animate space-y-3">
      <ArticleTopLayout entry={worldview} />
      {series && series.toLowerCase() !== "standalone" && (
        <div class="flex flex-wrap items-center gap-2 text-xs uppercase text-neutral-600 dark:text-neutral-300">
          <span class="px-2 py-1 rounded-full border border-black/15 dark:border-white/20">
            {series}
          </span>
          <span>
            {activePart ? `Part ${activePart}` : "Series entry"}
            {seriesEntries.length > 1 ? ` of ${seriesEntries.length}` : ""}
          </span>
        </div>
      )}
    </div>
  </TopLayout>
  <BottomLayout>
    <div class="animate">
      <ArticleBottomLayout entry={worldview} />
    </div>

    {seriesEntries.length > 1 && (
      <section class="animate mt-10">
        <h2 class="text-lg font-semibold text-black dark:text-white mb-3">
          {series} Series
        </h2>
        <ol class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {seriesEntries.map((entry) => {
            const isActive = entry.slug === worldview.slug;
            const partNumber =
              (entry.data as any).part ?? (entry.data as any).day;
            return (
              <li>
                <a
                  href={`/${entry.collection}/${entry.slug}`}
                  class={cn(
                    "block h-full rounded-lg border p-4 transition-colors duration-200 ease-in-out",
                    "border-black/15 dark:border-white/20 hover:bg-black/5 hover:dark:bg-white/10",
                    isActive &&
                      "border-black dark:border-white bg-black/5 dark:bg-white/10 pointer-events-none",
                  )}
                  aria-current={isActive ? "page" : undefined}
                >
                  <div class="text-xs uppercase text-neutral-600 dark:text-neutral-300">
                    {partNumber ? `Part ${partNumber}` : "Entry"}
                  </div>
                  <div class="font-semibold text-black dark:text-white mt-1 line-clamp-2">
                    {entry.data.title}
                  </div>
                  <div class="text-sm mt-1 line-clamp-2 text-neutral-700 dark:text-neutral-300">
                    {entry.data.summary}
                  </div>
                </a>
              </li>
            );
          })}
        </ol>
      </section>
    )}
  </BottomLayout>
</PageLayout>
